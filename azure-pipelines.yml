trigger:
- main

pool:
  vmImage: ubuntu-latest

variables:
- name: azureSubscription
  value: 'EANDI-SSP-DEV-RG'

- name: webAppName
  value: 'eni-ssp-backend-dev'

- name: resourceGroupName
  value: 'DevResourceGroup-SSP-EUS'

- name: workingDirectory
  value: '.'

- group: eni-ssp-backend-dev

steps:
# 1) Install Node
- task: NodeTool@0
  inputs:
    versionSpec: '24.x'
  displayName: 'Install Node.js 24'

# 2) Install deps + optional build
- script: |
    set -e
    cd $(workingDirectory)
    npm ci
    if npm run | grep -qE ' build'; then
      npm run build
    else
      echo "No build script found, skipping build."
    fi
  displayName: 'Install dependencies and build (if applicable)'

# 3) Zip backend
- task: ArchiveFiles@2
  inputs:
    rootFolderOrFile: '$(workingDirectory)'
    includeRootFolder: false
    archiveType: 'zip'
    archiveFile: '$(Build.ArtifactStagingDirectory)/backend.zip'
    replaceExistingArchive: true
  displayName: 'Archive backend as ZIP'

# 4) Publish artifact (optional)
- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)/backend.zip'
    ArtifactName: 'backend'
    publishLocation: 'Container'
  displayName: 'Publish backend artifact'

# 5) Apply App Settings using Azure CLI (no JSON parsing errors)
- task: AzureCLI@2
  displayName: 'Apply App Settings (env vars) to Backend Web App'
  inputs:
    azureSubscription: '$(azureSubscription)'
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      az webapp config appsettings set \
        --resource-group "$(resourceGroupName)" \
        --name "$(webAppName)" \
        --settings \
          NODE_ENV="$(NODE_ENV)" \
          PORT="$(PORT)" \
          JWT_SECRET="$(JWT_SECRET)" \
          JWT_EXPIRES_IN="$(JWT_EXPIRES_IN)" \
          SAML_ISSUER="$(SAML_ISSUER)" \
          SAML_CALLBACK_URL="$(SAML_CALLBACK_URL)" \
          OKTA_SIGNON_URL="$(OKTA_SIGNON_URL)" \
          OKTA_SSO_URL="$(OKTA_SSO_URL)" \
          OKTA_METADATA_URL="$(OKTA_METADATA_URL)" \
          FRONTEND_SUCCESS_REDIRECT="$(FRONTEND_SUCCESS_REDIRECT)" \
          CORS_ORIGIN="$(CORS_ORIGIN)" \
          FRONTEND_BASE_URL="$(FRONTEND_BASE_URL)" \
          SESSION_SECRET="$(SESSION_SECRET)" \
          DATABASE_URL="$(DATABASE_URL)" \
          DB_SERVER="$(DB_SERVER)" \
          DB_USER="$(DB_USER)" \
          DB_PASSWORD="$(DB_PASSWORD)" \
          DB_NAME="$(DB_NAME)" \
          DB_PORT="$(DB_PORT)" \
          AZURE_STORAGE_CONNECTION_STRING="$(AZURE_STORAGE_CONNECTION_STRING)" \
          AZURE_DOWNLOAD_CONTAINERS="$(AZURE_DOWNLOAD_CONTAINERS)" \
          MAIL_USER="$(MAIL_USER)" \
          MAIL_PASS="$(MAIL_PASS)" \
          MAIL_HOST="$(MAIL_HOST)" \
          MAIL_PORT="$(MAIL_PORT)" \
          NOTIFY_TO="$(NOTIFY_TO)" \
          PIPELINE_TRIGGER_URL="$(PIPELINE_TRIGGER_URL)"

      echo "âœ… App settings applied."

# 5b) OPTIONAL: Set OKTA_X509_CERT separately (ONLY IF you stored it as ONE LINE with \n)
- task: AzureCLI@2
  displayName: 'Set OKTA_X509_CERT (optional)'
  condition: and(succeeded(), ne(variables['OKTA_X509_CERT'], ''))
  inputs:
    azureSubscription: '$(azureSubscription)'
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      az webapp config appsettings set \
        --resource-group "$(resourceGroupName)" \
        --name "$(webAppName)" \
        --settings OKTA_X509_CERT="$(OKTA_X509_CERT)"

# 6) Deploy ZIP to Azure Web App
- task: AzureWebApp@1
  displayName: 'Deploy backend.zip to Azure Web App'
  inputs:
    azureSubscription: '$(azureSubscription)'
    appName: '$(webAppName)'
    package: '$(Build.ArtifactStagingDirectory)/backend.zip'
